(()=>{var e={};e.id=6073,e.ids=[6073],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31183:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});var s=r(96330);let n=global.prisma??new s.PrismaClient},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},51485:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>f,serverHooks:()=>x,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>g,OPTIONS:()=>p,POST:()=>w});var n=r(96559),i=r(48088),a=r(37719),o=r(32190),u=r(31183),c=r(52822),d=r(97240);function l(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization"),e}async function p(){return l(new o.NextResponse(null,{status:204}))}async function w(e){let t=e.headers.get("authorization")?.replace("Bearer ",""),r=process.env.DASHBOARD_TOKEN;if(!t||t!==r)return l(o.NextResponse.json({error:"Unauthorized"},{status:401}));try{let t;let r=await e.json();if(!r.id||!r.brand)return l(o.NextResponse.json({error:"Missing required fields"},{status:400}));let s=r.id.trim(),n=r.clientName?.trim()||"Unknown",i=r.subject?.trim()||"Untitled",a=r.lastMessage??"";if(r.ownerId)t=r.ownerId;else if(r.ownerEmail){let e=await u.A.user.findUnique({where:{email:r.ownerEmail.toLowerCase().trim()},select:{id:!0}});t=e?.id}let p=r.issueCategory?.trim()||null,w=r.ticketUrl?.trim()||(0,c.Q)(s),g=(0,d.WU)(r.date),f=(0,d.av)(g),m=(0,d.ho)(s,g),{start:h,end:x}=(0,d.gA)(g),A=await u.A.ticket.findFirst({where:{createdAt:{gte:h,lt:x},OR:[{id:s},{id:m}]},orderBy:{createdAt:"desc"}}),k={brand:r.brand,clientName:n,subject:i,product:r.product,issueCategory:p,ticketUrl:w,status:r.status,lastMessage:a,date:f,clientMsgs:r.clientMsgs,agentMsgs:r.agentMsgs,...t?{ownerId:t}:{}},v=A?await u.A.ticket.update({where:{id:A.id},data:k}):await u.A.ticket.create({data:{id:m,...k}}),U=v.ownerId??t;if(U)try{await u.A.notification.create({data:{ticketId:v.id,userId:U,message:function(e,t,r){let s=r?.replace(/\s+/g," ").trim(),n=`New activity on ${e||"a ticket"} for ${t||"a client"}.`;return(s&&s.length>0?s:n).slice(0,280)}(i,n,a||void 0)}})}catch(e){console.error("Failed to record notification",e)}return l(o.NextResponse.json({success:!0,ticket:v}))}catch(t){let e=t instanceof Error?t.message:"Failed to process request";return l(o.NextResponse.json({error:e},{status:500}))}}async function g(){let e=await u.A.ticket.findMany({orderBy:{updatedAt:"desc"}});return l(o.NextResponse.json(e))}let f=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/tickets/route",pathname:"/api/tickets",filename:"route",bundlePath:"app/api/tickets/route"},resolvedPagePath:"/Users/iwan/Downloads/New Chat/new-support/src/app/api/tickets/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:h,serverHooks:x}=f;function A(){return(0,a.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:h})}},52822:(e,t,r)=>{"use strict";r.d(t,{Q:()=>n});var s=r(97240);function n(e){let t=process.env.NEXT_PUBLIC_WORLDHOST_SUPPORT_INBOX_URL??"https://admin.worldhost.group/admin/support/inbox",r=(0,s.Zz)(e);return`${t.replace(/\/$/,"")}/${r}`}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{},97240:(e,t,r)=>{"use strict";r.d(t,{WU:()=>a,Zz:()=>i,av:()=>o,gA:()=>c,ho:()=>u});let s="__day__",n=/^\d{4}-\d{2}-\d{2}$/;function i(e){if(!e)return e;let t=e.trim(),r=t.lastIndexOf(s);if(-1===r)return t;let i=t.slice(r+s.length);return n.test(i)?t.slice(0,r):t}function a(e){if(e){let t=new Date(e);if(!Number.isNaN(t.getTime()))return t}return new Date}function o(e){return e.toISOString().slice(0,10)}function u(e,t){let r=e.trim(),n=o(t);return`${r}${s}${n}`}function c(e){let t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())),r=new Date(t);return r.setUTCDate(r.getUTCDate()+1),{start:t,end:r}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580],()=>r(51485));module.exports=s})();